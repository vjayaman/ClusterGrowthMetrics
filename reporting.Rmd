---
title: "Overview"
output: 
  html_document:
    code_fold: show
runtime: shiny
---

```{r setup, include=FALSE}
source("functions/base_functions.R")
source("functions/processing_functions.R")
library(ggplot2)
library(plotly)
library(DT)
library(flexdashboard)
```


### Chart A1

```{r}
# metrics <- readRDS("outputs/results_summary.Rds")
# propnames <- colnames(metrics)
# 
# metrics <- metrics %>% set_colnames(c("tp1_h", "tp1_cl", "tp1_cl_size", "tp2_h", "tp2_cl",
#                                       "tp2_cl_size", "num_novels", "flag", "id", "flagged_heights",
#                                       "prop_inc", "b_ov_growth", "adap_thresh", "fold_change")) %>% arrange(-fold_change)
time1_raw <- "data/timepoint1_data.csv" %>% readBaseData(., 1)
time2_raw <- "data/timepoint2_data.csv" %>% readBaseData(., 2)
```

```{r}
heights <- colnames(time1_raw)[-1]
renderUI({
  selectInput(inputId = "sel_height", label = "Select height to analyze", choices = heights, selected = heights[10])
})
```

```{r}
user <- reactiveValues(h = NULL, cl = NULL)
observe({user$h <- input$sel_height})
observe({user$cl <- input$sel_cluster})
```


```{r}
renderDataTable({
  req(user$h)
  h <- user$h
  b1 <- readRDS(paste0("outputs/with_growth_rate//h", h, ".Rds"))
  b1$id <- paste0("T1_h", b1$tp1_h, "_cl", b1$tp1_cl)
  
  DT::datatable(b1, caption = paste0("Growth rates of all TP1_h", h, " clusters at all TP2 heights"), 
                fillContainer = TRUE, filter = "top", rownames = TRUE, 
                options = list(pageLength = 1635, dom = "tipf", scrollY = "500px", 
                               columnDefs = list(list(className = "dt-center", targets = 1:5))))
}, server = TRUE)
```

```{r}
# a1 <- readRDS("outputs/with_growth_rate/h200.Rds")
# a2 <- a1 %>% filter(tp1_cl == 2) %>% arrange(tp2_h, tp2_cl)
# ggplot(a2, aes(x = tp2_h, y = tp2_cl_size)) + geom_point()
# ggplot(a2, aes(x = tp2_h, y = actual_growth_rate)) + geom_point()
# ggplot(a2, aes(x = tp2_h, y = b_ov_growth)) + geom_point()
```


```{r}
renderDataTable({
  req(user$h)
  h <- user$h
  c1 <- readRDS(paste0("outputs/best_growth_per_clust/h", h, ".Rds"))
  c1$id <- paste0("T1_h", c1$tp1_h, "_cl", c1$tp1_cl)
  
  DT::datatable(c1, caption = paste0("The TP1-TP2 cluster pairs with the 'most' growth, for all TP1_h", h, " clusters"), 
                fillContainer = TRUE, filter = "top", rownames = TRUE, 
                options = list(pageLength = nrow(c1), dom = "tipf", scrollY = "500px", 
                               columnDefs = list(list(className = "dt-center", targets = 1:5))))
}, server = TRUE)
```

```{r}
renderDataTable({
  req(user$h)
  h <- user$h
  print(paste0("outputs/with_growth_rate/h", h, ".Rds"))
  b1 <- readRDS(paste0("outputs/with_growth_rate//h", h, ".Rds"))
  b1$id <- paste0("T1_h", b1$tp1_h, "_cl", b1$tp1_cl)
  
  
  DT::datatable(b1, caption = "Growth rates of this TP1 cluster at all TP2 heights", 
                fillContainer = TRUE, filter = "top", rownames = TRUE, 
                options = list(pageLength = 1635, dom = "tipf", scrollY = "500px", 
                               columnDefs = list(list(className = "dt-center", targets = 1:5))))
}, server = TRUE)
```

```{r}
renderUI({
  req(user$h)
  h <- user$h
  
  b1 <- readRDS(paste0("outputs/with_growth_rate/h", h, ".Rds"))
  b1$id <- paste0("T1_h", b1$tp1_h, "_cl", b1$tp1_cl)
  tp1_clusters <- b1$id %>% unique()
  
  selectInput(inputId = "sel_cluster", label = "Select cluster to analyze", choices = tp1_clusters)
})
```

```{r}
renderPlot({
  req(user$h); req(user$cl)
  h <- user$h
  cl <- user$cl
  
  b1 <- readRDS(paste0("outputs/with_growth_rate/h", h, ".Rds"))
  b1$id <- paste0("T1_h", b1$tp1_h, "_cl", b1$tp1_cl)
  # onecluster <- b1 %>% filter(tp1_cl == 10)
  onecluster <- b1 %>% filter(id == cl)
  t1_vals <- onecluster %>% select(tp1_h, tp1_cl) %>% unique()
  top_pt <- onecluster[which.max(onecluster$b_ov_growth),]
  
  # cl <- onecluster$id %>% unique()
  g1 <- ggplot(onecluster, aes(x = tp2_h, y = b_ov_growth)) + geom_point() + 
    geom_point(data = top_pt, aes(x = tp2_h, y = b_ov_growth), color = "red", size = 3) + 
    xlab("Time point 2 thresholds") + ylab("Growth 'acceleration'") + 
    ggtitle(paste0("Growth of ", cl, " to time point 2"))
  g1
})
```

```{r}
renderPlot({
  req(user$h); req(user$cl)
  h <- user$h
  cl <- user$cl
  
  b1 <- readRDS(paste0("outputs/with_growth_rate/h", h, ".Rds"))
  b1$id <- paste0("T1_h", b1$tp1_h, "_cl", b1$tp1_cl)
  
})
```

### Chart A2

```{r}
renderPlotly({
  req(user$h)
  h <- user$h
  # the most cluster growth for each TP1 cluster, at threshold h
  c1 <- readRDS(paste0("outputs/best_growth_per_clust/h", h, ".Rds"))
  g2 <- ggplot(c1, aes(x = tp1_cl, y = b_ov_growth)) + geom_point()
  ggplotly(g2)
})
```

### Chart A1

```{r}

```

### Chart A2

```{r}

```

### Chart B

```{r}

```

### Chart C

```{r}

```
