---
title: "Overview"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    output: html_document
---

<style type="text/css">

.chart-title {
   font-size: 20px;
}
</style>

```{r setup, include=FALSE}
# WORKING DIRECTORY: ClusterGrowthMetrics

source("functions/base_functions.R")
source("functions/processing_functions.R")
x <- c("ggplot2", "plotly", "flexdashboard", "RColorBrewer", "shinyjs", "DT")
lapply(x, require, character.only = TRUE)

metrics <- readData("outputs/all_clusters_table.csv") %>%
  set_colnames(c("isolate", "tp1_h", "tp1_cl", "tp2_h", "tp2_cl", "tp1_cl_size",
                 "tp2_cl_size", "flag", "num_novels", "prop_inc", "adap_thresh", "fold_change"))
# metrics <- readRDS("data/metrics.Rds")

clusters <- metrics %>% select(-isolate) %>% unique() %>% 
# clusters <- readRDS("data/clusters.Rds") %>% 
  createID("tp1_h", "tp1_cl") %>% rename(tp1_id = id) %>% 
  createID("tp2_h", "tp2_cl") %>% rename(tp2_id = id)

flagged <- clusters %>% filter(flag != "sb")
flagged$num_novels[is.na(flagged$num_novels)] <- 0

# the cluster assignments, in form: || isolates | height 0 | height 1 | ... ||
# the raw datasets, no filtering or other changes made
time1_raw <- "data/timepoint1_data.csv" %>% readData(.,1)
time2_raw <- "data/timepoint2_data.csv" %>% readData(.,2)

a1 <- time1_raw %>% dplyr::select(-isolate) %>% 
    melt() %>% as_tibble() %>% unique() %>% 
    group_by(variable) %>% 
    summarise(n = n(), .groups = "drop") %>% 
    set_colnames(c("h", "TP1"))

a2 <- time2_raw %>% dplyr::select(-isolate) %>% 
  melt() %>% as_tibble() %>% unique() %>% 
  group_by(variable) %>% 
  summarise(n = n(), .groups = "drop") %>% 
  set_colnames(c("h", "TP2"))
```

Data overview
=======================================================================
Row {data-height=500}
-----------------------------------------------------------------------

### Flagged clusters (all "newly formed" TP2 clusters and the originating TP1 cluster (flags))
```{r}
# DT::dataTableOutput("flaggedDT")
# output$flaggedDT <- DT::renderDataTable({
#   flagged %>% dplyr::select(-tp1_id, -tp2_id) %>% 
#     set_colnames(c("TP1 height", "TP1 cluster", "TP2 height", "TP2 cluster", "TP1 cluster size", 
#                    "TP2 cluster size", "Flag (originating TP1 cluster)", "Number of novels in TP2 cluster", 
#                    "Proportional increase", "Adaptive threshold", "Fold change")) %>% 
#   DT::datatable(., rownames = FALSE, class = "cell-border stripe", 
#                 options = list(pageLength = nrow(flagged), scrollY = "375px", dom = "tif", 
#                                columnDefs = list(list(className = "dt-center", targets = "_all"))), 
#                 selection = list(target = "row", mode = "single")) %>% 
#     formatRound(table = ., columns = 9, digits = 3)
# }, server = TRUE)
```


Row {data-height=500 .tabset}
-----------------------------------------------------------------------

### Select a row in the table above to see *all* TP2 cluster details

```{r}
# DT::dataTableOutput("selectedClusters")
# 
# output$selectedClusters <- DT::renderDataTable({
#   req(input$flaggedDT_rows_selected)
#   
#   selected <- flagged[input$flaggedDT_rows_selected,]
#   df <- metrics %>% filter(tp2_h == selected$tp2_h & tp2_cl == selected$tp2_cl)
#   df %>% set_colnames(c("Isolate", "TP1 height", "TP1 cluster", "TP2 height", "TP2 cluster", 
#                         "TP1 cluster size", "TP2 cluster size", "Flag (originating TP1 cluster)", 
#                         "Number of novels in TP2 cluster", "Proportional increase", 
#                         "Adaptive threshold", "Fold change")) %>% 
#   DT::datatable(., rownames = FALSE, class = "cell-border stripe", 
#                 options = list(pageLength = nrow(df), scrollY = "375px", dom = "tif", 
#                                columnDefs = list(list(className = "dt-center", targets = 1:(ncol(df)-1)))), 
#                 selection = list(target = "row", mode = "single")) %>% 
#     formatRound(table = ., columns = 10, digits = 3)
# })
```

### Plot of selected cluster (tracked)

```{r}
# renderPlotly({
#   req(input$flaggedDT_rows_selected)
#   
#   withProgress(message = "Preparing plot", value = 0, {
#     
#     selected <- flagged[input$flaggedDT_rows_selected,]
#     df <- metrics %>% filter(tp2_h == selected$tp2_h & tp2_cl == selected$tp2_cl)
#   
#     incProgress(1/5)
#     b1 <- metrics %>% filter(isolate %in% df$isolate) %>% 
#       select(-isolate) %>% unique() %>% 
#       rownames_to_column("id") %>% 
#       arrange(tp2_h, tp2_cl) %>% 
#       mutate(across(id, as.integer))
# 
#     incProgress(1/5)
#     b4 <- b1 %>% select(id, tp1_cl_size, tp2_cl_size) %>% 
#       set_colnames(c("id", "TP1", "TP2")) %>% 
#       melt(id = "id") %>% as_tibble() %>% 
#       set_colnames(c("Rows (from previous tab)", "TP", "Cluster size")) %>% 
#       mutate(across(TP, as.character))
#   
#     incProgress(1/5)
#     flags <- b1 %>% filter(flag != "sb") %>% pull(id)
#   
#     tmp1 <- b1 %>% select(id, tp1_h, tp1_cl, tp1_cl_size) %>% 
#       add_column("TP" = "TP1", .after = 1) %>% 
#       set_colnames(c("Rows (from previous tab)", "TP", "height", "cluster", "Cluster size"))
#     tmp2 <- b1 %>% select(id, tp2_h, tp2_cl, tp2_cl_size) %>% 
#       add_column("TP" = "TP2", .after = 1) %>% 
#       set_colnames(c("Rows (from previous tab)", "TP", "height", "cluster", "Cluster size"))
#   
#     incProgress(1/5)
#     b5 <- b4 %>% left_join(., bind_rows(tmp1, tmp2), 
#                            by = c("Rows (from previous tab)", "TP", "Cluster size"))
#   
#     text1 <- paste0("Cluster type: ", b5$TP, "\nHeight: ", b5$height, 
#                     "\nCluster: ", b5$cluster, "\nCluster size: ", b5$`Cluster size`, 
#                     "\nRow number: ", b5$`Rows (from previous tab)`)
#   
#     incProgress(1/5)
#     b5$TP[b5$`Rows (from previous tab)` %in% flags] <- "Flagged"
#   })
#   
#   {ggplot(b5, aes(x = `Rows (from previous tab)`, y = `Cluster size`, color = TP, text = text1)) + 
#       geom_point() + 
#       ggtitle("Sizes of the clusters from the previous tab (ordered by TP2 height then cluster)") + 
#       scale_color_manual(values = c("black", "forestgreen", "darkmagenta"))} %>% 
#     ggplotly(tooltip = "text1")
# })
```


All clusters
=======================================================================

Row {data-height=100}
-----------------------------------------------------------------------

### ALL TP1 clusters
```{r}
# m1 <- max(clusters$tp1_cl_size)
# sliderInput("tp1_size_range", "Cluster sizes to include in the TP1 histogram:",  
#              value = c(10, m1), min = 1, max = m1)
```

### ALL TP2 clusters
```{r}
# m2 <- max(clusters$tp2_cl_size)
# sliderInput("tp2_size_range", "Cluster sizes to include in the TP1 histogram:", 
#              value = c(10, m2), min = 1, max = m2)
```

### Violin plot of cluster sizes
```{r}
# sliderInput("violin_size_range", "Cluster sizes to include in the violin plot:", 
#              value = c(10, m2), min = 1, max = m2)
```

### Number of TP2 clusters 
```{r}
# renderValueBox({
#   clusters %>% select(tp2_h, tp2_cl) %>% unique() %>% nrow() %>% 
#     valueBox(value = ., icon = "ion-bar-outline")
# })
```

### 

Row {data-height=750 .tabset}
-----------------------------------------------------------------------
  
### ALL TP1 clusters
```{r}
# renderPlotly({
#   min_size <- input$tp1_size_range[1]
#   max_size <- input$tp1_size_range[2]
#   all_tp1_sizes <- clusters$tp1_cl_size %>% 
#     plotCS("tp1_cl_size") %>% 
#     filter(tp1_cl_size >= min_size) %>% 
#     filter(tp1_cl_size <= max_size)
# 
#   {ggplot(all_tp1_sizes, aes(x = tp1_cl_size, y = count)) + geom_bar(stat = "identity", fill = "forestgreen") + 
#       xlab("Cluster size") + ylab("Number of clusters") + 
#       ggtitle(paste0("Histogram of cluster sizes for TP1, for clusters with sizes in [", 
#                      min_size, ",", max_size, "]"))} %>% ggplotly()
# })
```

### ALL TP2 clusters
```{r}
# renderPlotly({
#   min_size <- input$tp2_size_range[1]
#   max_size <- input$tp2_size_range[2]
#   all_tp2_sizes <- clusters$tp2_cl_size %>% 
#     plotCS("tp2_cl_size") %>% 
#     filter(tp2_cl_size >= min_size) %>% 
#     filter(tp2_cl_size <= max_size)
# 
#   {ggplot(all_tp2_sizes, aes(x = tp2_cl_size, y = count)) + geom_bar(stat = "identity", fill = "darkmagenta") + 
#       xlab("Cluster size") + ylab("Number of clusters") + 
#       ggtitle(paste0("Histogram of cluster sizes for TP2, for clusters with sizes in [", 
#                      min_size, ",", max_size, "]"))} %>% ggplotly()  
# })
```

### Violin plot of cluster sizes
```{r}
# renderPlotly({
#   min_size <- input$violin_size_range[1]
#   max_size <- input$violin_size_range[2]
#   a <- clusters[,c("tp1_cl_size", "tp2_cl_size")] %>% 
#     set_colnames(c("TP1", "TP2")) %>% melt() %>% 
#     as_tibble() %>% set_colnames(c("Timepoint", "CS")) %>% 
#     filter(CS >= min_size) %>% 
#     filter(CS <= max_size)
# 
#   {ggplot(a, aes(Timepoint, CS, fill = Timepoint, color = Timepoint)) + 
#       geom_violin() + xlab("Timepoint") + ylab("Cluster Size") + 
#       scale_color_manual(values = c("forestgreen", "darkmagenta")) + 
#       scale_fill_manual(values = c("forestgreen", "darkmagenta")) + 
#       ggtitle(paste0("Density of flagged clusters with indicated cluster sizes, at TP1 and TP2"), 
#               subtitle = paste0("(", nrow(a), " clusters represented"))} %>% 
#     ggplotly() %>% 
#     layout(title = list(text = paste0("Density of all clusters with indicated cluster sizes, at TP1 ", 
#                                       "and TP2<br><sup>(", nrow(a), " clusters represented)</sup>")))
# })
```

### Number of clusters by height
```{r}
# renderPlotly({
#   a3 <- full_join(a1, a2, by = "h") %>% as_tibble() %>% 
#     melt(id = "h") %>% as_tibble() %>% factorToInt("h") %>% 
#     set_colnames(c("Height", "Timepoint", "Number of clusters"))
#   
#   {ggplot(a3, aes(x = Height, y = `Number of clusters`, fill = Timepoint)) + 
#       scale_fill_manual(values = c("forestgreen", "darkmagenta")) + 
#       ggtitle("") + 
#       geom_bar(stat = "identity", position = "dodge")} %>% 
#     ggplotly()
# })
# #   - a barplot of the number of clusters at each height (shaded by average cluster size)
```




Flagged clusters 
=======================================================================

Row {data-height=100}
-----------------------------------------------------------------------

### ALL TP1 cluster sizes 
```{r}
# f1 <- max(flagged$tp1_cl_size)
# sliderInput("fc_sizes_tp1", "Cluster sizes to include in the TP1 histogram:", 
#              value = c(10, f1), min = 1, max = f1)
```

### ALL TP2 cluster sizes 
```{r}
# f2 <- max(flagged$tp2_cl_size)
# sliderInput("fc_sizes_tp2", "Cluster sizes to include in the TP1 histogram:", 
#              value = c(10, f2), min = 1, max = f2)
```

### Violin plot of cluster sizes
```{r}
# sliderInput("fc_violin_sizes", "Cluster sizes to include in the violin plot:", 
#              value = c(10, f2), min = 1, max = f2)
```

### Number of flagged TP2 clusters
```{r}
# renderValueBox({
#   flagged$flag %>% unique() %>% length() %>% 
#     valueBox(value = ., icon = "ion-bar-outline")
# })
```

### 

Row {data-height=750 .tabset}
-----------------------------------------------------------------------
  
### ALL TP1 cluster sizes 
```{r}
# renderPlotly({
#   min_size <- input$fc_sizes_tp1[1]
#   max_size <- input$fc_sizes_tp1[2]
#   
#   df_tp1 <- flagged$tp1_cl_size %>% 
#     plotCS("tp1_cl_size") %>% 
#     filter(tp1_cl_size >= min_size) %>% 
#     filter(tp1_cl_size <= max_size)
# 
#   {ggplot(df_tp1, aes(x = tp1_cl_size, y = count)) + geom_bar(stat = "identity", fill = "forestgreen") + 
#       xlab("Cluster size") + ylab("Number of clusters") + 
#       ggtitle(paste0("Histogram of cluster sizes for TP1, for flagged clusters with sizes in [", 
#                      min_size, ",", max_size, "]"))} %>% 
#     ggplotly()
# })
```

### ALL TP2 cluster sizes 
```{r}
# renderPlotly({
#   min_size <- input$fc_sizes_tp2[1]
#   max_size <- input$fc_sizes_tp2[2]
#   
#   df_tp2 <- flagged$tp2_cl_size %>% 
#     plotCS("tp2_cl_size") %>% 
#     filter(tp2_cl_size >= min_size) %>% 
#     filter(tp2_cl_size <= max_size)
# 
# {ggplot(df_tp2, aes(x = tp2_cl_size, y = count)) + geom_bar(stat = "identity", fill = "darkmagenta") + 
#     xlab("Cluster size") + ylab("Number of clusters") + 
#     ggtitle(paste0("Histogram of cluster sizes for TP1, for flagged clusters with sizes in [", 
#                      min_size, ",", max_size, "]"))} %>% 
#     ggplotly()
# })
```

### Violin plot of cluster sizes
```{r}
# renderPlotly({
#   min_size <- input$fc_violin_sizes[1]
#   max_size <- input$fc_violin_sizes[2]
#   
#   a <- flagged[,c("tp1_cl_size", "tp2_cl_size")] %>% 
#     set_colnames(c("TP1", "TP2")) %>% melt() %>% 
#     as_tibble() %>% set_colnames(c("Timepoint", "CS")) %>% 
#     filter(CS >= min_size) %>% 
#     filter(CS <= max_size)
# 
#   {ggplot(a, aes(Timepoint, CS, fill = Timepoint, color = Timepoint)) + 
#       geom_violin() + xlab("Timepoint") + ylab("Cluster Size") + 
#       scale_color_manual(values = c("forestgreen", "darkmagenta")) + 
#       scale_fill_manual(values = c("forestgreen", "darkmagenta")) + 
#       ggtitle(paste0("Density of flagged clusters with indicated cluster sizes, at TP1 and TP2"), 
#               subtitle = paste0("(", nrow(a), " clusters represented"))} %>% 
#     ggplotly() %>% 
#     layout(title = list(text = paste0("Density of flagged clusters with indicated cluster sizes, at TP1 ", 
#                                       "and TP2<br><sup>(", nrow(a), " clusters represented)</sup>")))
# })
```



Page 4 {data-orientation=columns}
=======================================================================
Column {data-width=500}
-----------------------------------------------------------------------

### Tracking the flagged clusters (from TP1 to TP2)

```{r}
# actual_sizes <- time1_raw %>% melt(id = "isolate") %>% 
#   as_tibble() %>% dplyr::select(-isolate) %>% 
#   group_by_all() %>% summarise(n = n(), .groups = "drop") %>% 
#   set_colnames(c("h", "cl", "size")) %>% 
#   factorToInt("h") %>% 
#   createID("h", "cl")
# 
# ids <- flagged %>% filter(num_novels != 0) %>% pull(tp1_id)
# 
# df <- clusters %>% filter(tp1_id %in% ids) %>% arrange(tp1_h, tp1_cl)
# 
# selectInput(inputId = "flagged_clusters", choices = df$tp1_id %>% unique(), 
#             label = "Select a TP1 originating cluster to track through TP2:")
```

```{r}
# renderPlotly({
#   idx <- input$flagged_clusters
#   df1 <- df %>% filter(tp1_id == idx)
#   
#   dfa <- df1 %>% dplyr::select(tp1_h, tp1_cl_size) %>% 
#     add_column(tp = "Number of originals at TP1", .before = 1) %>% 
#     set_colnames(c("tp", "h", "size"))
#   
#   dfb <- df1 %>% dplyr::select(tp2_h, tp2_cl_size) %>% 
#     add_column(tp = "TP2", .before = 1) %>% 
#     set_colnames(c("tp", "h", "size"))
#   
#   df2 <- bind_rows(dfa, dfb) %>% unique() %>% 
#     add_row(tp = "Actual TP1 size", h = unique(dfa$h), size = actual_sizes$size[actual_sizes$id == idx])
#   
#   
#   {ggplot(df2, aes(x = h, y = size, color = tp)) + 
#     scale_color_manual(values = c("darkblue", "forestgreen", "darkmagenta")) + 
#     geom_point()} %>% 
#     ggplotly()
# })
```


Column {data-width=500}
-----------------------------------------------------------------------

### 

```{r}

```

### 

```{r plot3}
# Flagged cluster sizes, Close-up of flagged cluster sizes
#   - the cluster size differences between TP1 and TP2 (as a histogram)
#     - for all clusters
#     - for the flagged ones only


#   - a barplot of the number of clusters at each height (shaded by average cluster size)

#     - if you click on a bar, you get a scatter plot of the clusters at that height, at TP1, blue
#       - y axis is size of cluster, x is ?
#     - if you click on a bar, you get a scatter plot of the clusters at that height, at TP2, red
#       - y axis is size of cluster, x is ?

#     - if you click on a cluster at TP1, you get a bubble plot of that cluster overlayed by the clusters it is the 
#     foundation for at TP2, so we can see the growth
```
